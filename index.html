<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Lab</title>

    <!-- Anti-flash: apply saved theme before any paint -->
    <script>
      (function () {
        try {
          if (localStorage.getItem('imagelab-theme') === 'dark')
            document.documentElement.classList.add('dark-mode');
        } catch (e) {}
      })();
    </script>

    <!-- Electron fix: hide Node.js module system so UMD libraries
         take the browser path and set proper window globals. -->
    <script>
      if (typeof module !== 'undefined') {
        window.__module = module;
        module = undefined;
      }
    </script>

    <!-- blockly package -->
    <script src="./node_modules/blockly/blockly_compressed.js"></script>
    <script src="./node_modules/blockly/blocks_compressed.js"></script>
    <script src="./node_modules/blockly/msg/en.js"></script>

    <!-- plugins used for improving blockly interaction -->
    <script src="./node_modules/@blockly/field-slider/dist/index.js"></script>
    <script src="./node_modules/@blockly/field-angle/dist/index.js"></script>
    <script src="./node_modules/@blockly/field-colour/dist/index.js"></script>
    <script src="./node_modules/@blockly/plugin-workspace-search/dist/index.js"></script>

    <!-- Register Blockly field plugins (v12+ requires explicit registration) -->
    <script>
      if (typeof registerFieldAngle === 'function') registerFieldAngle();
      if (typeof registerFieldColour === 'function') registerFieldColour();
    </script>

    <!-- Restore Node.js module system for app scripts that use require(). -->
    <script>
      if (window.__module) {
        module = window.__module;
        delete window.__module;
      }
    </script>

    <!-- color palette (slightly desaturated for modern look) -->
    <script>
      Blockly.utils.colour.setHsvSaturation(0.55);
      Blockly.utils.colour.setHsvValue(0.75);
    </script>

    <!-- icons library and styles -->
    <link
      rel="stylesheet"
      href="./node_modules/@mdi/font/css/materialdesignicons.min.css"
    />
    <link rel="stylesheet" href="./styles/style.css" />
  </head>

  <body>
    <!-- Navbar -->
    <div class="app-navbar">
      <div class="navbar-left">
        <span class="toggle" title="Toggle theme"></span>
        <span class="wave"></span>
      </div>
    </div>

    <!-- Main content area -->
    <div class="app-main">
      <!-- Left column: sidebar + workspace + info -->
      <div class="main-left">
        <div class="custom-sidebar" id="customSidebar"></div>
        <div class="main-left-content">
          <div class="playground-pane pane">
            <div id="blocklyDiv"></div>
          </div>
          <div class="information-pane" id="information-pane">
            <p id="operator_name">Operation name</p>
            <p id="operator_description">here is the operation description</p>
          </div>
        </div>
      </div>

      <!-- Right column: preview + properties -->
      <div class="main-right">
        <div class="preview-pane pane">
          <div class="pane-header">
            <div class="pane-actions">
              <span
                onclick="executeProcess()"
                accesskey="r"
                title="Run (Alt+R)"
                class="mdi mdi-play-circle-outline icon-btn icon-btn--success"
              ></span>
              <span
                onclick="undo()"
                title="Undo"
                class="mdi mdi-undo icon-btn"
              ></span>
              <span
                onclick="redo()"
                title="Redo"
                class="mdi mdi-redo icon-btn"
              ></span>
              <span
                onclick="downloadImage()"
                title="Download"
                class="mdi mdi-download icon-btn"
              ></span>
            </div>
            <span class="pane-title">Preview</span>
            <div class="pane-actions">
              <span
                class="mdi mdi-replay icon-btn icon-btn--danger"
                onclick="resetWorkspace()"
                title="Reset"
              ></span>
            </div>
          </div>
          <div class="image-preview-div">
            <canvas id="image-preview"></canvas>
          </div>
          <div class="zoom-controls">
            <span
              class="mdi mdi-plus-circle-outline icon-btn"
              onclick="zoomin()"
              title="Zoom in"
            ></span>
            <span
              class="mdi mdi-minus-circle-outline icon-btn"
              onclick="zoomout()"
              title="Zoom out"
            ></span>
          </div>
        </div>
        <div class="properties-pane pane">
          <div class="pane-header">
            <span class="pane-title">Properties</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Note: ordering of files is important -->
    <script src="src/ui/titlebar.js"></script>
    <script src="src/blocks/index.js"></script>
    <script src="src/blockly/extensions.js"></script>
    <script src="src/blockly/workspace-setup.js"></script>
    <script src="src/ui/sidebar.js"></script>
    <script src="src/ui/dialog.js"></script>
    <script src="src/ui/workspace-events.js"></script>
    <script src="src/ui/image-controls.js"></script>
    <script src="src/ui/theme-toggle.js"></script>

    <!-- file selector for browse blocks for read/write image -->
    <img id="input-image" style="display: none" />
    <input
      type="file"
      id="inputImage"
      name="avatar"
      accept=".jpg , .png"
      style="display: none"
      onchange="loadFile()"
    />
    <input
      style="display: none"
      id="outputDirectory"
      type="file"
      webkitdirectory
      directory
      multiple
      onchange="setDirectory()"
    />
  </body>
</html>
